# =============================================================================
# Unit Test + Code Coverage — GitHub Actions
#
# Runs all BSW and ECU unit tests, collects gcov/lcov coverage data,
# and uploads HTML coverage report as artifact.
#
# IEC 61508-3 Table B.2 / ISO 26262-6 Table 12 coverage targets:
#   Function:  100%
#   Statement: 100%
#   Branch:    100%
#   MC/DC:     100% (measured separately via condition coverage)
# =============================================================================

name: Tests & Coverage

on:
  push:
    paths:
      - 'firmware/**'
      - 'tools/**'
      - '.github/workflows/test.yml'
  pull_request:
    paths:
      - 'firmware/**'
      - 'tools/**'
      - '.github/workflows/test.yml'

jobs:
  # -------------------------------------------------------------------
  # BSW unit tests + coverage
  # -------------------------------------------------------------------
  bsw-tests:
    name: BSW Unit Tests + Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install coverage tools
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Run BSW tests with coverage
        working-directory: firmware/shared/bsw
        run: make coverage

      - name: Upload BSW coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bsw-coverage
          path: firmware/shared/bsw/coverage/
          retention-days: 30

      - name: BSW coverage summary
        if: always()
        working-directory: firmware/shared/bsw
        run: |
          echo "=== BSW Coverage Summary ==="
          if [ -f coverage/bsw-filtered.info ]; then
            lcov --summary coverage/bsw-filtered.info --rc branch_coverage=1
          else
            echo "No coverage data generated."
          fi

  # -------------------------------------------------------------------
  # ECU tests + coverage (matrix across all 7 ECUs)
  # -------------------------------------------------------------------
  ecu-tests:
    name: "${{ matrix.ecu }} Tests + Coverage"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ecu: [bcm, icu, tcu, cvc, fzc, rzc, sc]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          # ICU needs ncurses for build
          if [ "${{ matrix.ecu }}" = "icu" ]; then
            sudo apt-get install -y libncurses-dev
          fi

      - name: Run ${{ matrix.ecu }} tests with coverage
        working-directory: firmware
        run: make -f Makefile.posix TARGET=${{ matrix.ecu }} coverage

      - name: Upload ${{ matrix.ecu }} coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "${{ matrix.ecu }}-coverage"
          path: "firmware/coverage/${{ matrix.ecu }}/"
          retention-days: 30

  # -------------------------------------------------------------------
  # Combined coverage report (merges BSW + all ECUs)
  # -------------------------------------------------------------------
  combined-coverage:
    name: Combined Coverage Report
    runs-on: ubuntu-latest
    needs: [bsw-tests, ecu-tests]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Merge coverage data
        run: |
          mkdir -p coverage/combined
          lcov_args=""

          # BSW coverage
          if [ -f artifacts/bsw-coverage/bsw-filtered.info ]; then
            lcov_args="$lcov_args -a artifacts/bsw-coverage/bsw-filtered.info"
          fi

          # ECU coverage
          for ecu in bcm icu tcu cvc fzc rzc sc; do
            if [ -f "artifacts/${ecu}-coverage/filtered.info" ]; then
              lcov_args="$lcov_args -a artifacts/${ecu}-coverage/filtered.info"
            fi
          done

          if [ -n "$lcov_args" ]; then
            lcov $lcov_args -o coverage/combined/total.info --rc branch_coverage=1
            genhtml coverage/combined/total.info \
              --output-directory coverage/combined/html \
              --branch-coverage \
              --title "Taktflow Embedded — Combined Coverage"

            echo "=== Combined Coverage Summary ==="
            lcov --summary coverage/combined/total.info --rc branch_coverage=1
          else
            echo "WARNING: No coverage data found in artifacts"
            exit 1
          fi

      - name: Upload combined coverage report
        uses: actions/upload-artifact@v4
        with:
          name: combined-coverage
          path: coverage/combined/
          retention-days: 90

      - name: Coverage gate check
        run: |
          if [ ! -f coverage/combined/total.info ]; then
            echo "No combined coverage data — skipping gate"
            exit 0
          fi

          echo "=== Coverage Gate Check ==="
          SUMMARY=$(lcov --summary coverage/combined/total.info --rc branch_coverage=1 2>&1)
          echo "$SUMMARY"

          # Extract function coverage percentage
          FUNC_COV=$(echo "$SUMMARY" | grep "functions" | grep -oP '[\d.]+%' | head -1 | tr -d '%')
          LINE_COV=$(echo "$SUMMARY" | grep "lines" | grep -oP '[\d.]+%' | head -1 | tr -d '%')
          BRANCH_COV=$(echo "$SUMMARY" | grep "branches" | grep -oP '[\d.]+%' | head -1 | tr -d '%')

          echo ""
          echo "Function coverage: ${FUNC_COV:-N/A}%"
          echo "Line coverage:     ${LINE_COV:-N/A}%"
          echo "Branch coverage:   ${BRANCH_COV:-N/A}%"
          echo ""
          echo "Targets (IEC 61508 SIL 2 / ISO 26262 ASIL D):"
          echo "  Function:  100%"
          echo "  Statement: 100%"
          echo "  Branch:    100%"
          echo ""

          # Report current baseline — gate enforcement will be enabled
          # once Phase 2 (test hardening) achieves target coverage
          echo "NOTE: Coverage gate enforcement pending Phase 2 completion."
          echo "Current metrics logged for baseline tracking."

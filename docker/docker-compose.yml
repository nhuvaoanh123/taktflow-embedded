# =============================================================================
# docker-compose.yml — Full SIL Demo Platform
#
# 7 simulated ECUs + plant simulator + MQTT + CAN gateway + WebSocket bridge
# + Caddy reverse proxy + SAP QM mock + ML inference + fault injection
#
# Usage:
#   docker compose up --build        Start all services (foreground)
#   docker compose up --build -d     Start all services (background)
#   docker compose down              Stop all services
#   docker compose logs -f cvc       Follow CVC logs
#
# Prerequisites (on VPS host, one-time):
#   sudo modprobe vcan
#   echo vcan | sudo tee /etc/modules-load.d/vcan.conf   # persist across reboots
# =============================================================================

services:
  # --- vcan0 setup (runs once, exits) ---
  can-setup:
    build:
      context: ..
      dockerfile: docker/Dockerfile.can-setup
    command: >
      /bin/sh -c "
        modprobe vcan 2>/dev/null || true;
        if ip link show vcan0 > /dev/null 2>&1; then
          ip link set vcan0 up;
          echo '[can-setup] vcan0 already existed — set UP';
        elif ip link add vcan0 type vcan; then
          ip link set vcan0 up;
          echo '[can-setup] created vcan0 — set UP';
        else
          echo '[can-setup] ERROR: cannot create vcan0 — vcan module not loaded';
          echo '[can-setup] Run on VPS host:  sudo modprobe vcan';
          echo '[can-setup] Persist:  echo vcan | sudo tee /etc/modules-load.d/vcan.conf';
          exit 1;
        fi;
        ip -d link show vcan0
      "
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - /lib/modules:/lib/modules:ro
    network_mode: host
    restart: "no"

  # --- Central Vehicle Computer ---
  cvc:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vecu
    network_mode: host
    cap_add:
      - NET_ADMIN
    depends_on:
      can-setup:
        condition: service_completed_successfully
    environment:
      - CAN_INTERFACE=vcan0
      - ECU_NAME=cvc
    restart: unless-stopped

  # --- Front Zone Controller ---
  fzc:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vecu
    network_mode: host
    cap_add:
      - NET_ADMIN
    depends_on:
      can-setup:
        condition: service_completed_successfully
    environment:
      - CAN_INTERFACE=vcan0
      - ECU_NAME=fzc
    restart: unless-stopped

  # --- Rear Zone Controller ---
  rzc:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vecu
    network_mode: host
    cap_add:
      - NET_ADMIN
    depends_on:
      can-setup:
        condition: service_completed_successfully
    environment:
      - CAN_INTERFACE=vcan0
      - ECU_NAME=rzc
    restart: unless-stopped

  # --- Safety Controller ---
  sc:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vecu
    network_mode: host
    cap_add:
      - NET_ADMIN
    depends_on:
      can-setup:
        condition: service_completed_successfully
    environment:
      - CAN_INTERFACE=vcan0
      - ECU_NAME=sc
    restart: unless-stopped

  # --- Body Control Module ---
  bcm:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vecu
    network_mode: host
    cap_add:
      - NET_ADMIN
    depends_on:
      can-setup:
        condition: service_completed_successfully
    environment:
      - CAN_INTERFACE=vcan0
      - ECU_NAME=bcm
    restart: unless-stopped

  # --- Instrument Cluster Unit ---
  icu:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vecu
    network_mode: host
    cap_add:
      - NET_ADMIN
    depends_on:
      can-setup:
        condition: service_completed_successfully
    environment:
      - CAN_INTERFACE=vcan0
      - ECU_NAME=icu
    stdin_open: true
    tty: true
    restart: unless-stopped

  # --- Telematics Control Unit ---
  tcu:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vecu
    network_mode: host
    cap_add:
      - NET_ADMIN
    depends_on:
      can-setup:
        condition: service_completed_successfully
    environment:
      - CAN_INTERFACE=vcan0
      - ECU_NAME=tcu
    restart: unless-stopped

  # --- Plant Physics Simulator ---
  plant-sim:
    build:
      context: ..
      dockerfile: gateway/plant_sim/Dockerfile
    network_mode: host
    depends_on:
      can-setup:
        condition: service_completed_successfully
    environment:
      - CAN_CHANNEL=vcan0
      - DBC_PATH=/app/taktflow.dbc
    restart: unless-stopped

  # --- Mosquitto MQTT Broker (internal only) ---
  mqtt-broker:
    image: eclipse-mosquitto:2
    network_mode: host
    volumes:
      - ../gateway/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    restart: unless-stopped

  # --- CAN-to-MQTT Gateway ---
  can-gateway:
    build:
      context: ..
      dockerfile: gateway/can_gateway/Dockerfile
    network_mode: host
    cap_add:
      - NET_ADMIN
    depends_on:
      can-setup:
        condition: service_completed_successfully
      mqtt-broker:
        condition: service_started
    environment:
      - CAN_CHANNEL=vcan0
      - DBC_PATH=/app/taktflow.dbc
      - MQTT_HOST=localhost
      - MQTT_PORT=1883
    restart: unless-stopped

  # --- WebSocket Telemetry Bridge ---
  ws-bridge:
    build:
      context: ..
      dockerfile: gateway/ws_bridge/Dockerfile
    network_mode: host
    depends_on:
      mqtt-broker:
        condition: service_started
    environment:
      - MQTT_HOST=localhost
      - MQTT_PORT=1883
      - WS_PORT=8080
    restart: unless-stopped

  # --- Caddy Reverse Proxy (auto-TLS) ---
  caddy:
    image: caddy:2
    network_mode: host
    volumes:
      - ../gateway/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      ws-bridge:
        condition: service_started
    restart: unless-stopped

  # --- SAP QM Mock API ---
  sap-qm-mock:
    build:
      context: ..
      dockerfile: gateway/sap_qm_mock/Dockerfile
    network_mode: host
    depends_on:
      mqtt-broker:
        condition: service_started
    environment:
      - MQTT_HOST=localhost
      - MQTT_PORT=1883
      - SAP_PORT=8090
    restart: unless-stopped

  # --- ML Anomaly Detection ---
  ml-inference:
    build:
      context: ..
      dockerfile: gateway/ml_inference/Dockerfile
    network_mode: host
    depends_on:
      mqtt-broker:
        condition: service_started
    environment:
      - MQTT_HOST=localhost
      - MQTT_PORT=1883
    restart: unless-stopped

  # --- Fault Injection API ---
  fault-inject:
    build:
      context: ..
      dockerfile: gateway/fault_inject/Dockerfile
    network_mode: host
    cap_add:
      - NET_ADMIN
    depends_on:
      can-setup:
        condition: service_completed_successfully
      mqtt-broker:
        condition: service_started
    environment:
      - CAN_CHANNEL=vcan0
      - FAULT_PORT=8091
      - MQTT_HOST=localhost
      - MQTT_PORT=1883
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:

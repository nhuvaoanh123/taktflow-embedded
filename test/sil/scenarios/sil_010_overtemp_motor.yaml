# =============================================================================
# @file    sil_010_overtemp_motor.yaml
# @brief   SIL scenario: Motor overtemperature — derating and shutdown
# @aspice  SWE.5 — Software Component Verification & Integration
# @iso     ISO 26262 Part 6, Section 10 — Software Integration & Testing
# @date    2026-02-24
#
# Validates the motor thermal protection chain.  Sustained high torque
# causes the plant sim motor model temperature to rise.  The RZC monitors
# temperature on CAN 0x302 and must activate power derating above 80C
# and shut down the motor entirely above 100C (overtemp threshold).
# =============================================================================

name: "Motor Overtemperature"
id: "SIL-010"
description: >
  Inject sustained high torque via normal_drive to cause the plant sim
  motor model temperature to rise over time.  Monitor MotorTemp frames
  (0x302) on CAN.  Verify power derating activates when temperature
  exceeds 80C, and motor shutdown occurs when temperature exceeds 100C
  (overtemp threshold).  This exercises the full thermal protection path
  from sensor reading through derating to shutdown.
verifies:
  - "SWR-RZC-003"   # RZC motor thermal management and overtemp protection
aspice: "SWE.5"
iso_reference: "ISO 26262 Part 6, Section 10"
timeout_sec: 60

setup:
  - action: reset
    description: "Clear residual state and ensure motor is cold"
  - action: wait_state
    state: RUN
    timeout: 10
    description: "System must be in RUN before thermal test"

steps:
  - action: inject_scenario
    name: normal_drive
    description: "Apply 50% torque to begin heating the motor"
  - action: wait
    seconds: 10
    description: "Allow motor temperature to rise under sustained load"
  - action: inject_scenario
    name: overcurrent
    description: >
      Switch to overcurrent scenario (95% torque + brake) to accelerate
      heating — high current at stall generates maximum I2R losses.
  - action: wait
    seconds: 20
    description: "Allow temperature to reach derating threshold (~80C)"
  - action: wait
    seconds: 15
    description: "Continue to overtemp threshold (~100C) if model permits"

verdicts:
  - type: can_message
    can_id: 0x302
    field: motor_temp
    expected_above: 80
    description: "MotorTemp (0x302) must show temperature above 80C (derating zone)"

  - type: power_derating
    temp_threshold_c: 80
    description: "Power derating must activate when motor temp > 80C"

  - type: motor_shutdown
    within_ms: 45000
    description: "Motor must shut down when temperature exceeds 100C overtemp threshold"

  - type: vehicle_state
    expected: DEGRADED
    within_ms: 45000
    description: "Vehicle must enter DEGRADED when overtemp triggers motor derating/cutoff"

teardown:
  - action: reset
    description: "Clear overcurrent and thermal conditions"
  - action: wait
    seconds: 5
    description: "Allow motor temperature to begin cooling"

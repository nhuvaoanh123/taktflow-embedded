# =============================================================================
# @file    sil_018_gateway_sap_qm.yaml
# @brief   SIL scenario: Gateway SAP QM DTC forwarding and 8D report generation
# @aspice  SWE.5 â€” Software Component Verification & Integration
# @date    2026-02-25
#
# Validates that the gateway forwards DTC events to the SAP QM mock API
# and generates an 8D report template upon receiving a Q-Meldung number.
# =============================================================================

name: "Gateway SAP QM DTC Forwarding"
id: "SIL-018"
description: >
  Verify that when a DTC is raised (via overcurrent fault), the gateway
  forwards the event to the SAP QM mock API, receives a Q-Meldung number,
  and generates an 8D report template in gateway/reports/.
verifies:
  - "SWR-GW-005"   # SAP QM DTC Forwarding
  - "SWR-GW-006"   # 8D Report Template Generation
aspice: "SWE.5"
iso_reference: "ISO 26262 Part 6, Section 10"
timeout_sec: 30

setup:
  - action: reset
    description: "Clear residual state and previous reports"
  - action: wait
    seconds: 2
    description: "Allow all containers and SAP QM mock API to initialize"

steps:
  - action: wait_state
    state: RUN
    timeout: 10
    description: "Wait for system to reach RUN state"
  - action: inject_fault
    type: overcurrent
    value: 22.0
    description: "Inject overcurrent to trigger DTC (Dem records DTC 0x110001)"
  - action: wait
    seconds: 5
    description: "Wait for DTC to propagate via CAN to gateway"
  - action: wait
    seconds: 3
    description: "Wait for gateway to forward DTC to SAP QM mock and generate report"

verdicts:
  - type: mqtt_message
    topic: "vehicle/dtc/new"
    description: "Gateway publishes DTC event to vehicle/dtc/new MQTT topic"

  - type: http_request
    endpoint: "/api/qm/notification"
    method: POST
    description: "Gateway sends DTC to SAP QM mock API"

  - type: file_exists
    path: "gateway/reports/8D-*.json"
    description: "8D report template generated in gateway/reports/"

teardown:
  - action: reset
    description: "Return system to clean idle state"

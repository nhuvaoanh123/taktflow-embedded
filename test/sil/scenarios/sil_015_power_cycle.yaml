# =============================================================================
# @file    sil_015_power_cycle.yaml
# @brief   SIL scenario: Power cycle during operation — clean restart
# @aspice  SWE.5 — Software Component Verification & Integration
# @iso     ISO 26262 Part 6, Section 10 — Software Integration & Testing
# @date    2026-02-24
#
# Validates that the system recovers cleanly after all physical ECUs
# (CVC, FZC, RZC) are power-cycled simultaneously during active operation.
# Simulated by docker restart of all three containers.  All ECU heartbeats
# must resume, the vehicle must go through INIT -> RUN again, and
# previously stored DTCs must remain accessible after restart.
# =============================================================================

name: "Power Cycle During Operation"
id: "SIL-015"
description: >
  Start normal drive, then docker restart CVC, FZC, and RZC simultaneously
  to simulate a power cycle of all physical ECUs.  Verify clean restart
  within 5 seconds: all ECU heartbeats resume, vehicle state transitions
  through INIT -> RUN again, and previously recorded DTCs are still
  accessible (persisted across power cycle).  This tests boot robustness,
  state initialization, and non-volatile DTC storage.
verifies:
  - "SWR-BSW-001"   # System stability / boot robustness
  - "SWR-CVC-006"   # CVC clean restart after power cycle
aspice: "SWE.5"
iso_reference: "ISO 26262 Part 6, Section 10"
timeout_sec: 45

setup:
  - action: reset
    description: "Start from clean state"
  - action: wait_state
    state: RUN
    timeout: 10
    description: "Ensure system is in RUN"

  # Generate a DTC before power cycle to verify persistence
  - action: inject_scenario
    name: overcurrent
    description: "Trigger overcurrent to generate DTC 0xE301 for persistence test"
  - action: wait
    seconds: 3
    description: "Allow DTC to be stored in non-volatile memory"
  - action: reset
    description: "Clear active fault but DTC should be stored"
  - action: wait_state
    state: RUN
    timeout: 10
    description: "Return to RUN before power cycle"

steps:
  # Phase 1: Start normal operation
  - action: inject_scenario
    name: normal_drive
    description: "Establish active operation (50% torque forward)"
  - action: wait
    seconds: 2
    description: "Confirm motor is running"

  # Phase 2: Power cycle all physical ECUs simultaneously
  - action: docker_restart
    containers: [cvc, fzc, rzc]
    description: "Restart CVC, FZC, RZC simultaneously (simulates power cycle)"

  # Phase 3: Wait for recovery
  - action: wait
    seconds: 8
    description: "Allow all ECUs to reboot and complete startup sequence"

verdicts:
  - type: can_message
    can_id: 0x010
    within_ms: 5000
    description: "CVC heartbeat (0x010) must resume within 5 seconds of restart"

  - type: can_message
    can_id: 0x011
    within_ms: 5000
    description: "FZC heartbeat (0x011) must resume within 5 seconds of restart"

  - type: can_message
    can_id: 0x012
    within_ms: 5000
    description: "RZC heartbeat (0x012) must resume within 5 seconds of restart"

  - type: vehicle_state
    expected: INIT
    within_ms: 2000
    phase: "after_restart"
    description: "Vehicle must enter INIT state after power cycle"

  - type: vehicle_state
    expected: RUN
    within_ms: 8000
    phase: "after_restart"
    description: "Vehicle must reach RUN within 8 seconds of power cycle"

  - type: dtc_preserved
    can_id: 0x500
    dtc_code: 0xE301
    field: occurrence_count
    expected_min: 1
    description: >
      DTC 0xE301 occurrence count must survive power cycle (non-volatile
      storage).  Stored before restart, must be retrievable after restart.

  - type: all_heartbeats_active
    can_ids: [0x010, 0x011, 0x012]
    interval_ms: 50
    description: "All three physical ECU heartbeats must be active and periodic"

teardown:
  - action: reset
    description: "Clear all state and return to clean idle"
  - action: wait
    seconds: 3
    description: "Allow full system stabilization"

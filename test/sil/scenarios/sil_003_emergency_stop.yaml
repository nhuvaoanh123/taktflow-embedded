# =============================================================================
# @file    sil_003_emergency_stop.yaml
# @brief   SIL scenario: Emergency stop — all actuators to safe values
# @aspice  SWE.5 — Software Component Verification & Integration
# @iso     ISO 26262 Part 6, Section 10 — Software Integration & Testing
# @date    2026-02-24
#
# Validates the highest-priority safety function: E-Stop disables all
# actuators, applies emergency braking, de-energizes the motor, and
# transitions the vehicle to SAFE_STOP within the 100ms FTTI deadline.
# =============================================================================

name: "Emergency Stop"
id: "SIL-003"
description: >
  From RUN state with active motor output, inject an E-Stop (0x001) and
  verify all actuators reach safe values within 100ms: motor RPM = 0,
  brake = 100% (emergency), steering de-energized.  Vehicle state must
  transition to SAFE_STOP (state 4).  This is the most critical safety
  path in the system.
verifies:
  - "SWR-BSW-019"   # Safe state transition on critical fault
  - "SWR-CVC-003"   # CVC E-Stop processing and broadcast
aspice: "SWE.5"
iso_reference: "ISO 26262 Part 6, Section 10"
timeout_sec: 20

setup:
  - action: reset
    description: "Clear any prior fault state"
  - action: wait_state
    state: RUN
    timeout: 10
    description: "Ensure system is in RUN before E-Stop test"
  - action: inject_scenario
    name: normal_drive
    description: "Establish active motor output (50% torque) as pre-condition"
  - action: wait
    seconds: 2
    description: "Allow motor to reach steady-state RPM"

steps:
  - action: inject_scenario
    name: estop
    description: "Send EStop_Broadcast (0x001) with EStop_Active=1"
  - action: wait
    seconds: 1
    description: "Allow E-Stop to propagate through all ECUs"

verdicts:
  - type: vehicle_state
    expected: SAFE_STOP
    within_ms: 100
    description: "Vehicle state must reach SAFE_STOP within 100ms of E-Stop"

  - type: motor_shutdown
    within_ms: 100
    description: "Motor RPM must reach 0 within 100ms (de-energized)"

  - type: can_message
    can_id: 0x103
    field: brake_force
    expected: 100
    description: "Brake must be at 100% (emergency braking applied)"

  - type: can_message
    can_id: 0x001
    field: estop_active
    expected: 1
    description: "EStop_Broadcast frame confirms EStop_Active = 1"

  - type: can_message
    can_id: 0x101
    field: torque_request
    expected: 0
    description: "Torque request must be 0 after E-Stop"

  - type: can_message
    can_id: 0x102
    field: steer_angle
    expected: 0
    description: "Steering command must be at center (de-energized)"

teardown:
  - action: reset
    description: "Clear E-Stop and return to idle state"

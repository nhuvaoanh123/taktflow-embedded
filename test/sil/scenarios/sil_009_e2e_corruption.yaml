# =============================================================================
# @file    sil_009_e2e_corruption.yaml
# @brief   SIL scenario: E2E CRC corruption — frame rejection verification
# @aspice  SWE.5 — Software Component Verification & Integration
# @iso     ISO 26262 Part 6, Section 10 — Software Integration & Testing
# @date    2026-02-24
#
# Validates the E2E (End-to-End) protection layer by injecting a torque
# command frame with an intentionally corrupted CRC-8 SAE J1850 checksum.
# The receiving ECU must detect the CRC mismatch, reject the frame, and
# NOT apply the torque command.  E2E error counters must increment.
# =============================================================================

name: "E2E CRC Corruption"
id: "SIL-009"
description: >
  Inject a Torque_Request frame (0x101) with a corrupted CRC byte via
  direct python-can injection on vcan0 (bypassing the fault injection API
  to ensure the CRC is truly invalid).  Verify the receiving ECU (RZC)
  rejects the frame — motor RPM must not change.  Verify E2E error
  counter increments.  This tests the AUTOSAR E2E protection per
  ISO 26262 Part 6 communication safety requirements.
verifies:
  - "SWR-BSW-010"   # E2E CRC-8 SAE J1850 protection on CAN frames
  - "SWR-BSW-011"   # E2E frame rejection and error counter management
aspice: "SWE.5"
iso_reference: "ISO 26262 Part 6, Section 10"
timeout_sec: 20

setup:
  - action: reset
    description: "Clear residual state"
  - action: wait_state
    state: RUN
    timeout: 10
    description: "System must be in RUN for E2E test"
  - action: record_baseline
    metric: motor_rpm
    description: "Record current motor RPM as baseline (should be 0 at idle)"

steps:
  - action: inject_raw_can
    can_id: 0x101
    data: [0x12, 0xFF, 0x64, 0x01, 0x00, 0x00, 0x00, 0x00]
    description: >
      Inject Torque_Request with: AliveCounter=1, DataID=2, CRC=0xFF
      (intentionally wrong — correct CRC would be computed from payload).
      TorqueRequest=100% (byte 2 = 0x64), Direction=fwd (byte 3 = 0x01).
  - action: wait
    seconds: 1
    description: "Wait to confirm frame was rejected (no motor response)"
  - action: inject_raw_can
    can_id: 0x101
    data: [0x22, 0x00, 0x50, 0x01, 0x00, 0x00, 0x00, 0x00]
    description: "Second corrupted frame (CRC=0x00) to increment error counter"
  - action: wait
    seconds: 1
    description: "Allow E2E error counter to update"

verdicts:
  - type: motor_rpm_unchanged
    within_ms: 500
    description: "Motor RPM must NOT change — corrupted frame must be rejected"

  - type: e2e_error_count
    expected_min: 1
    description: "E2E error counter must increment (at least 1 rejected frame)"

  - type: vehicle_state
    expected: RUN
    within_ms: 500
    description: "Vehicle must remain in RUN — corrupted frame is not a vehicle fault"

  - type: can_message_absent
    can_id: 0x300
    field: rpm
    unexpected_value: [1, 65535]
    description: "MotorStatus must not show any RPM from the corrupted torque command"

teardown:
  - action: reset
    description: "Clear E2E error counters and return to idle"

# =============================================================================
# @file    sil_013_recovery_from_safe.yaml
# @brief   SIL scenario: Recovery from SAFE_STOP — clean restart sequence
# @aspice  SWE.5 — Software Component Verification & Integration
# @iso     ISO 26262 Part 6, Section 10 — Software Integration & Testing
# @date    2026-02-24
#
# Validates that the system can cleanly recover from SAFE_STOP state.
# After an E-Stop triggers SAFE_STOP, a reset command must bring the
# system back through INIT -> RUN.  Verify no lingering fault flags
# remain active, but DTCs are preserved (occurrence count > 0) for
# diagnostic retrieval.
# =============================================================================

name: "Recovery from Safe State"
id: "SIL-013"
description: >
  Trigger E-Stop to enter SAFE_STOP, then send a reset command.  Verify
  the system returns through the full INIT -> RUN startup sequence within
  5 seconds.  Confirm no lingering fault flags prevent normal operation,
  but DTC occurrence counts are preserved (not cleared by reset) so
  diagnostic tools can retrieve the fault history.
verifies:
  - "SWR-BSW-020"   # BswM mode transitions (SAFE_STOP -> INIT -> RUN)
aspice: "SWE.5"
iso_reference: "ISO 26262 Part 6, Section 10"
timeout_sec: 30

setup:
  - action: reset
    description: "Start from clean state"
  - action: wait_state
    state: RUN
    timeout: 10
    description: "Ensure system is in RUN"

steps:
  # Phase 1: Trigger SAFE_STOP
  - action: inject_scenario
    name: estop
    description: "Send E-Stop to force SAFE_STOP"
  - action: wait
    seconds: 2
    description: "Confirm vehicle is in SAFE_STOP"

  # Phase 2: Reset and recover
  - action: inject_scenario
    name: reset
    description: "Send reset command: clear E-Stop, zero all actuators"
  - action: wait
    seconds: 1
    description: "Allow reset to propagate"
  - action: wait_state
    state: RUN
    timeout: 10
    description: "Wait for recovery: SAFE_STOP -> INIT -> RUN"

verdicts:
  - type: vehicle_state
    expected: SAFE_STOP
    within_ms: 500
    phase: "after_estop"
    description: "Vehicle must be in SAFE_STOP after E-Stop (pre-condition)"

  - type: vehicle_state
    expected: RUN
    within_ms: 10000
    phase: "after_reset"
    description: "Vehicle must return to RUN within 10 seconds after reset"

  - type: can_message
    can_id: 0x001
    field: estop_active
    expected: 0
    description: "EStop_Active must be 0 after reset"

  - type: no_active_faults
    description: >
      No active fault flags remaining after recovery (DEM fault status
      cleared for current cycle)

  - type: dtc_preserved
    can_id: 0x500
    field: occurrence_count
    expected_min: 1
    description: >
      DTC occurrence count must be preserved (> 0) even after reset.
      DTCs are historical records — reset clears active status, not history.

  - type: can_message
    can_id: 0x010
    description: "CVC heartbeat resumed after recovery"

  - type: can_message
    can_id: 0x011
    description: "FZC heartbeat resumed after recovery"

  - type: can_message
    can_id: 0x012
    description: "RZC heartbeat resumed after recovery"

teardown:
  - action: reset
    description: "Ensure clean state for next test"
